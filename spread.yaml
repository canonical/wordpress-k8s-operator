project: wordpress-k8s-operator

path: /wordpress-k8s-operator
environment:
  PROJECT_PATH: /wordpress-k8s-operator
  SNAPD_TESTING_TOOLS: $PROJECT_PATH/tools/external/tools
  PATH: /snap/bin:$PATH:$SNAPD_TESTING_TOOLS
  CRAFT_DEBUG: 1 # Show exception tracebacks.
  CRAFT_VERBOSITY_LEVEL: debug # Show debugging output when failing.
  # Use the staging store for tests:
  CHARMCRAFT_STORE_API_URL: https://api.staging.charmhub.io
  CHARMCRAFT_UPLOAD_URL: https://storage.staging.snapcraftcontent.com
  CHARMCRAFT_REGISTRY_URL: https://registry.staging.jujucharms.com

exclude:
  - .git
  - .github
  - .tox
  - .venv
  - .*_cache
  - charmcraft
  - libexec
  - schema
  - snap

backends:
  multipass:
    type: adhoc
    allocate: |
      sleep 0.$RANDOM  # Minimize chances of a race condition
      mkdir -p $HOME/.spread
      export counter_file="$HOME/.spread/multipass-count"
      instance_num=$(flock -x $counter_file bash -c '
        [ -s $counter_file ] || echo 0 > $counter_file
        num=$(< $counter_file)
        echo $num
        echo $(( $num + 1 )) > $counter_file')

      multipass_image=$(echo ${SPREAD_SYSTEM} | sed -e s/ubuntu-// -e s/-64//)

      system=$(echo "${SPREAD_SYSTEM}" | tr . -)
      instance_name="spread-${SPREAD_BACKEND}-${instance_num}-${system}"

      multipass launch --cpus 4 --disk 50G --memory 8G --name "${instance_name}" "${multipass_image}"

      # Enable PasswordAuthentication for root over SSH.
      multipass exec "$instance_name" -- \
        sudo sh -c "echo root:${SPREAD_PASSWORD} | sudo chpasswd"
      multipass exec "$instance_name" -- \
        sudo sh -c \
        "if [ -d /etc/ssh/sshd_config.d/ ]
        then
          echo 'PasswordAuthentication yes' > /etc/ssh/sshd_config.d/10-spread.conf
          echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config.d/10-spread.conf
        else
          sed -i /etc/ssh/sshd_config -E -e 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/' -e 's/^#?PermitRootLogin.*/PermitRootLogin yes/'
        fi"
      multipass exec "$instance_name" -- \
        sudo systemctl restart ssh

      # Get the IP from the instance
      ip=$(multipass info --format csv "$instance_name" | tail -1 | cut -d\, -f3)
      ADDRESS "$ip"
    discard: |
      instance_name=$(multipass list --format csv | grep $SPREAD_SYSTEM_ADDRESS | cut -f1 -d\,)
      multipass delete --purge "${instance_name}"
    systems:
      - ubuntu-24.04-64:
          workers: 1

prepare: |
  sudo snap install --classic concierge
  sudo concierge prepare -p microk8s

suites:
  spread/: 
    summary: tutorial test
    systems:
      - ubuntu-24.04-64


